<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geminisnow</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      

        /* --- 1. Root Variables & Global Styles --- */
        :root {
            --font-family-sans: 'Google Sans', 'Noto Sans SC', sans-serif;
            
            /* Light Theme Palette */
            --bg-main: #f0f4f9;
            --bg-sidebar: #e6eaf1;
            --bg-content: #ffffff;
            --bg-input: #f0f4f9;
            --bg-input-focus: #e8eef4;
            --bg-hover-light: #d3e3fd;
            --bg-hover-dark: #dde3ea;
            --bg-active-item: #c2e7ff;
            --bg-ultra-badge: #e8e8e8;
            --bg-send-button: #297FE5; 
            --bg-send-button-hover: #1A73E8;
            --bg-modal-backdrop: rgba(0, 0, 0, 0.4);
            --canvas-icon-color: #5f6368;
            --canvas-icon-color-active: #1a73e8;

            --text-primary: #1f1f1f;
            --text-secondary: #444746;
            --text-placeholder: #5f6368;
            --text-on-dark-bg: #ffffff;
            --text-ultra-badge: #1f1f1f;
            --text-link: #0b57d0;

            --border-color: #d8dde3;
            --border-active: #0b57d0;
            
            --message-model-bg: linear-gradient(135deg, #f5f5f5, #ffffff);
            --message-user-bg: linear-gradient(135deg, #e9e9e9, #f7f7f7);
            --thinking-animation-bg: linear-gradient(90deg, #e9e9e9, #f7f7f7, #e9e9e9);
            --new-chat-btn-bg: var(--bg-main);
            --new-chat-btn-hover-bg: #f8fafd;
            --scrollbar-thumb-bg: #d6d6d6;
            --temp-slider-thumb-border: var(--bg-content);

            --sidebar-width: 256px;
            --header-height: 64px;

            --transition-speed-fast: 0.2s;
            --transition-speed-normal: 0.3s;
            --transition-easing: cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
            /* Dark Theme Palette */
            --bg-main: #131314;
            --bg-sidebar: #1e1f20;
            --bg-content: #131314;
            --bg-input: #2d2e30;
            --bg-input-focus: #3c3d3f;
            --bg-hover-light: #3c3d3f;
            --bg-hover-dark: #28292a;
            --bg-active-item: #04395e;
            --bg-ultra-badge: #3c3d3f;
            --bg-send-button: #89b4e4; 
            --bg-send-button-hover: #93c5fd;
            --bg-modal-backdrop: rgba(0, 0, 0, 0.6);
            --canvas-icon-color: #969ba1;
            --canvas-icon-color-active: #89b4e4;

            --text-primary: #e3e3e3;
            --text-secondary: #969ba1;
            --text-placeholder: #7f8287;
            --text-on-dark-bg: #131314;
            --text-ultra-badge: #e3e3e3;
            --text-link: #89b4e4;

            --border-color: #3c3d3f;
            --border-active: #89b4e4;

            --message-model-bg: linear-gradient(135deg, #2a2b2d, #1e1f20);
            --message-user-bg: linear-gradient(135deg, #2d2e30, #232425);
            --thinking-animation-bg: linear-gradient(90deg, #2a2b2d, #3c3d3f, #2a2b2d);
            --new-chat-btn-bg: var(--bg-input);
            --new-chat-btn-hover-bg: #3c3d3f;
            --scrollbar-thumb-bg: #4a4c4e;
            --temp-slider-thumb-border: var(--bg-input);
        }


        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-family-sans);
            color: var(--text-primary);
            background-color: var(--bg-main);
            display: flex;
            transition: background-color var(--transition-speed-normal) ease;
        }

        button, input, textarea {
            font-family: inherit;
        }

        svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            color: var(--text-secondary);
        }
        
        .icon-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: none;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease;
        }
        .icon-button:hover {
            background-color: var(--bg-input);
        }
        .icon-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: transparent;
        }

        /* --- 2. Main Layout & Sidebar --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }

        #sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-modal-backdrop);
            z-index: 199;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-speed-normal) ease;
        }
        .app-container:not(.sidebar-collapsed) #sidebar-backdrop {
            display: block;
            opacity: 1;
            pointer-events: auto;
        }

        #sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            padding: 16px 12px;
            flex-shrink: 0;
            position: absolute;
            top: 0;
            left: 0;
            transform: translateX(0);
            transition: transform var(--transition-speed-normal) var(--transition-easing), background-color var(--transition-speed-normal) ease;
            z-index: 200;
            box-shadow: 4px 0 15px -5px rgba(0,0,0,0.1);
        }

        .app-container.sidebar-collapsed #sidebar {
            transform: translateX(-100%); 
            box-shadow: none;
        }
        
        .main-content-area {
            flex-grow: 1;
            height: 100%;
            transition: margin-left var(--transition-speed-normal) var(--transition-easing);
            margin-left: var(--sidebar-width);
            position: relative; /* Needed for canvas positioning */
        }

        .app-container.sidebar-collapsed .main-content-area {
            margin-left: 0;
        }
        
        @media (max-width: 1024px) {
             #sidebar {
                width: 280px;
             }
        }

        @media (max-width: 768px) {
            body {
                zoom: 0.85;
            }
            .main-content-area {
                margin-left: 0 !important;
            }
            #sidebar {
                width: 85%;
                max-width: 320px;
            }
        }


        .sidebar-header {
            margin-bottom: 16px;
            padding: 0 4px;
        }

        #new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 52px;
            padding: 0 24px 0 4px;
            background-color: var(--new-chat-btn-bg);
            border: none;
            border-radius: 26px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-speed-fast) ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        #new-chat-btn:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            background-color: var(--new-chat-btn-hover-bg);
        }
        
        #new-chat-btn .icon-placeholder {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #history-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 4px;
        }
        #history-list::-webkit-scrollbar {
            width: 6px;
        }
        #history-list::-webkit-scrollbar-track {
            background: transparent;
            margin: 4px 0;
        }
        #history-list::-webkit-scrollbar-thumb {
            background-color: #a0a8b3;
            border-radius: 6px;
            border: 1px solid var(--bg-sidebar);
        }
        #history-list::-webkit-scrollbar-thumb:hover {
            background-color: #858e9c;
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 16px;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease;
            margin-bottom: 4px;
        }
        .history-item:hover {
            background-color: var(--bg-hover-dark);
        }
        .history-item.active {
            background-color: var(--bg-active-item);
            font-weight: 500;
        }
        .history-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }
        .delete-chat-btn {
            background: none; border: none; cursor: pointer;
            opacity: 0; transition: opacity var(--transition-speed-fast) ease;
            display: flex; align-items: center; justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .delete-chat-btn svg {
            width: 18px;
            height: 18px;
        }
        .history-item:hover .delete-chat-btn {
            opacity: 0.7;
        }
        .delete-chat-btn:hover {
            opacity: 1;
            background-color: rgba(0,0,0,0.1);
        }

        #sidebar-footer {
            position: relative;
            padding: 0 4px;
        }
        
        #settings-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-normal) ease;
        }
        #settings-button:hover {
            background-color: var(--bg-hover-dark);
            transform: rotate(90deg);
        }
        
        #settings-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 100%;
            margin-bottom: 8px;
            background-color: var(--bg-content);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: all var(--transition-speed-fast) ease, background-color var(--transition-speed-normal) ease;
        }
        #settings-menu.active {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .settings-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color var(--transition-speed-fast) ease;
        }
        .settings-menu-item:hover {
            background-color: var(--bg-hover-dark);
        }


        /* --- 3. Main Content Area --- */
        .chat-area {
            width: 100%;
            height: 100%;
            background-color: var(--bg-content);
            display: grid;
            grid-template-rows: var(--header-height) 1fr auto;
            position: relative;
            transition: background-color var(--transition-speed-normal) ease;
        }

        /* --- 4. Header --- */
        .chat-header {
            grid-row: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            flex-shrink: 0;
            background: transparent;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-title-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-title-group h1 {
            font-size: 1.375rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .model-selector-wrapper {
            position: relative;
        }

        .selected-model {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease;
        }
        .selected-model:hover {
            background-color: var(--bg-input);
        }
        #selected-model-display {
            font-size: 1.375rem;
            font-weight: 400;
            color: var(--text-secondary);
        }
        .selected-model svg {
            width: 20px;
            height: 20px;
        }

        .model-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background-color: var(--bg-content);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 320px;
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: all var(--transition-speed-fast) ease, background-color var(--transition-speed-normal) ease;
        }
        .model-dropdown.active {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .model-option h4 { font-weight: 500; }
        .model-option p { font-size: 0.8rem; color: var(--text-secondary); }
        .checkmark { color: var(--text-link); }

        .ultra-badge {
            background-color: var(--bg-ultra-badge);
            color: var(--text-ultra-badge);
            font-size: 0.8rem;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 8px;
            letter-spacing: 0.5px;
            transition: background-color var(--transition-speed-normal) ease, color var(--transition-speed-normal) ease;
        }

        /* --- 5. Chat Output --- */
        .chat-output-wrapper {
            grid-row: 2;
            overflow: hidden;
            position: relative;
        }
        .chat-output-wrapper::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 30px;
            pointer-events: none;
            z-index: 2;
            top: 0;
            background: linear-gradient(to bottom, var(--bg-content), transparent);
            transition: background var(--transition-speed-normal) ease;
        }
        .chat-output-wrapper::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            pointer-events: none;
            z-index: 2;
            background: linear-gradient(to top, var(--bg-content), transparent);
            transition: background var(--transition-speed-normal) ease;
            display: block;
        }

        #chatOutput {
            height: 100%;
            overflow-y: auto;
            padding: 0 24px 16px 24px;
        }
        #chatOutput::-webkit-scrollbar { width: 8px; }
        #chatOutput::-webkit-scrollbar-track { background: transparent; }
        #chatOutput::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb-bg);
            border-radius: 10px;
            border: 2px solid var(--bg-content);
            transition: background-color var(--transition-speed-normal) ease;
        }

        .chat-content-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            height: 100%;
        }
        
        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .message.fade-in-whole, .message.content-refreshed {
            animation: floatIn 0.5s var(--transition-easing) forwards;
        }

        @keyframes thinking-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .message-wrapper {
            animation: floatIn 0.5s var(--transition-easing);
            display: flex;
            flex-direction: column;
        }
        .message-wrapper.user {
            align-items: flex-end;
        }
        .message-wrapper.model {
            align-items: flex-start;
        }
        .message-wrapper:hover .message-actions {
            opacity: 1;
            transform: translateY(0);
        }

        .chat-content-container > .message-wrapper:last-of-type {
            margin-bottom: 45vh;
        }

        .welcome-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
        }
        .welcome-message {
            flex-grow: 0;
        }
        .welcome-message h2 {
            font-size: 3.5rem;
            font-weight: 500;
            background: linear-gradient(45deg, #2196F3, #E91E63, #2196F3);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: floatIn 0.7s var(--transition-easing) forwards, gradient-animation 8s ease infinite;
            background-size: 200% 200%;
        }
        
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .message {
            max-width: 100%;
            padding: 1rem 1.25rem;
            border-radius: 20px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: background var(--transition-speed-normal) ease, color var(--transition-speed-normal) ease;
        }
        .message.is-editing {
            border: 2px solid var(--border-active);
            box-shadow: 0 0 0 4px var(--bg-hover-light);
            padding: 0;
            background: var(--bg-input-focus);
        }
        .message.thinking-animation {
            color: var(--text-secondary);
            font-style: italic;
            background: var(--thinking-animation-bg);
            background-size: 200% 200%;
            animation: thinking-gradient 2.5s ease infinite;
        }

        .message-wrapper.model .message {
            border-top-left-radius: 4px;
            background: var(--message-model-bg);
            color: var(--text-primary);
        }
        .message-wrapper.user .message {
            background: var(--message-user-bg);
            color: var(--text-primary);
            border-bottom-right-radius: 4px;
        }
        .message p:not(:last-child) {
            margin-bottom: 1em;
        }
        .message ul, .message ol {
            padding-left: 1.5em;
        }
        .message pre {
            background-color: #1e1e1e; color: #d4d4d4; padding: 16px;
            border-radius: 8px; position: relative;
            margin: 1em 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message code { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace; font-size: 14px; }
        .copy-code-button {
            position: absolute; top: 10px; right: 10px; background-color: #555; color: white;
            border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; opacity: 0;
            transition: opacity var(--transition-speed-fast);
        }
        .message pre:hover .copy-code-button { opacity: 1; }
        .copy-code-button:hover { background-color: #666; }
        
        .message-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            opacity: 0;
            transition: opacity var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
        }
        .message-wrapper.model .message-actions {
            margin-bottom: 8px;
            transform: translateY(5px);
        }
        .message-wrapper.user .message-actions {
            display: flex !important;
            opacity: 1 !important;
            transform: translateY(0) !important;
            transition: opacity 0.2s ease, transform 0.2s ease;
            margin-top: 8px;
            justify-content: flex-end; /* 按钮右对齐 */
        }
                .message-wrapper.user:hover .message-actions {
            opacity: 1;
            transform: translateY(0);
        }
        
        .action-button {
            background-color: var(--bg-content);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all var(--transition-speed-fast) ease;
            color: var(--text-primary);
        }
        body.dark-mode .action-button {
            color: #fff;
        }
         .action-button:hover {
            background-color: var(--bg-input);
         }
         .action-button svg {
            width: 16px; height: 16px;
            color: currentColor;
         }
         .action-button.regenerate-button svg {
            width: 18px; height: 18px;
         }
        
        @keyframes loading-gradient {
            0% { background-color: rgba(60, 61, 63, 0.5); }
            50% { background-color: rgba(80, 81, 83, 0.6); }
            100% { background-color: rgba(60, 61, 63, 0.5); }
        }

        #summarize-btn {
            gap: 8px;
            padding: 8px 16px;
            width: auto;
            height: auto;
        }
        #summarize-btn svg {
            width: 18px; height: 18px;
        }
        
        .rewrite-options {
            display: flex;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-5px);
            transition: opacity 0.2s ease, visibility 0s 0.2s, transform 0.2s ease;
        }
        .rewrite-options.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            transition: opacity 0.2s ease, visibility 0s 0s, transform 0.2s ease;
        }
        .message-loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 10;
            font-size: 0.9rem;
            font-weight: 500;
            animation: fadeIn 0.3s ease, loading-gradient 2s ease-in-out infinite;
        }


        /* --- 6. Chat Input Area --- */
        .chat-input-area {
            grid-row: 3;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 24px 0 24px;
            flex-direction: column;
            background: transparent;
        }
        .chat-input-container {
            width: 100%;
            max-width: 800px;
            position: relative;
            margin-top: 12px;
        }
        .chat-input {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            min-height: 56px;
            background-color: var(--bg-input);
            border-radius: 28px;
            padding: 8px 12px 8px 16px; /* Adjusted padding for canvas toggle */
            transition: background-color var(--transition-speed-normal) ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .chat-input:focus-within {
            background-color: var(--bg-input-focus);
        }

        #userInput {
            flex-grow: 1;
            border: none;
            background: transparent;
            font-size: 1rem;
            line-height: 1.5;
            outline: none;
            color: var(--text-primary);
            resize: none;
            overflow-y: hidden;
            padding: 8px 0;
            max-height: 125px; 
            scrollbar-width: none; 
        }
        #userInput::-webkit-scrollbar {
            display: none; 
        }
        #userInput::placeholder {
            color: var(--text-placeholder);
        }

        #sendButton {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: var(--bg-send-button);
            cursor: pointer;
            transition: all var(--transition-speed-fast) ease;
            transform: scale(0);
            opacity: 0;
            flex-shrink: 0;
        }
        #sendButton svg {
            color: var(--text-on-dark-bg);
        }
        #sendButton:hover:not(:disabled) {
            background-color: var(--bg-send-button-hover);
            transform: scale(1.05);
        }
        #sendButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #sendButton.visible {
            transform: scale(1);
            opacity: 1;
        }
        #sendButton.hidden-by-edit {
            transform: scale(0);
            opacity: 0;
        }
        #sendButton .stop-icon { display: none; }
        #sendButton.is-loading .send-icon { display: none; }
        #sendButton.is-loading .stop-icon { display: block; }
        #sendButton.is-loading { background-color: #dc3545; }

        .disclaimer-text {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 12px 1rem;
            background: transparent;
        }

        /* --- 7. Modals & Canvas --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-modal-backdrop);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed-normal) ease, visibility 0s var(--transition-speed-normal);
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity var(--transition-speed-normal) ease;
        }
        .modal-content {
            background-color: var(--bg-content);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transform: scale(0.95);
            opacity: 0;
            transition: transform var(--transition-speed-normal) var(--transition-easing), opacity var(--transition-speed-normal) ease, background-color var(--transition-speed-normal) ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-content.content-fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 1.25rem; font-weight: 500; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .modal-intro { color: var(--text-secondary); margin-bottom: 24px; font-size: 0.9rem; line-height: 1.5; }
        .modal-intro b { color: var(--text-primary); font-weight: 500; }
        
        #modal-title { margin-bottom: 8px; }
        #modal-message { margin-bottom: 16px; color: var(--text-secondary); white-space: pre-wrap; max-height: 60vh; overflow-y: auto;}
        #modal-input-wrapper { margin-bottom: 24px; }
        #modal-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: var(--bg-input); color: var(--text-primary); }
        #modal-input:focus { border-color: var(--border-active); outline: none; box-shadow: 0 0 0 2px var(--bg-hover-light); }
        #modal-button-wrapper { display: flex; justify-content: flex-end; gap: 8px; }
        .modal-btn { padding: 10px 24px; border-radius: 20px; border: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background-color var(--transition-speed-fast) ease; }
        #modal-confirm-btn { background-color: var(--text-link); color: var(--text-on-dark-bg); }
        body.light-mode #modal-confirm-btn { color: white; }
        #modal-confirm-btn:hover { background-color: #0a4cb0; }
        body.dark-mode #modal-confirm-btn:hover { background-color: #93c5fd; }
        #modal-cancel-btn { background-color: transparent; color: var(--text-link); }
        #modal-cancel-btn:hover { background-color: var(--bg-hover-light); }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--text-link); }
        input:checked + .slider:before { transform: translateX(20px); }

        .custom-preset-container { margin-top: 16px; }
        .custom-preset-toggle-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        #custom-preset-input { width: 100%; min-height: 100px; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); resize: vertical; background-color: var(--bg-input); color: var(--text-primary); }
        .options-list { display: flex; flex-direction: column; gap: 16px; }
        .option-item { display: flex; justify-content: space-between; align-items: center; }
        .option-item p.jieshao { color: var(--text-secondary); font-size: 0.8rem; }
        
        #temperature-slider {
            -webkit-appearance: none;
            appearance: none;
            flex-grow: 1;
            max-width: 150px;
            height: 6px;
            background: var(--bg-hover-dark);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            transition: all var(--transition-speed-fast) ease;
        }
        #temperature-slider:hover {
            opacity: 0.9;
        }
        #temperature-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--text-link);
            border-radius: 50%;
            border: 3px solid var(--temp-slider-thumb-border);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            margin-top: -6px;
            transition: transform var(--transition-speed-fast) ease;
        }
        #temperature-slider:hover::-webkit-slider-thumb,
        #temperature-slider:focus::-webkit-slider-thumb {
             transform: scale(1.1);
        }
        #temperature-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--text-link);
            border-radius: 50%;
            border: 3px solid var(--temp-slider-thumb-border);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        /* --- Canvas Styles (NEW & MODIFIED) --- */
        .canvas-toggle-label {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color var(--transition-speed-fast) ease;
        }
        .canvas-toggle-label:hover {
            background-color: var(--bg-input-focus);
        }
        #canvas-toggle:disabled + .canvas-toggle-icon {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .canvas-toggle-label input {
            display: none;
        }
        .canvas-toggle-icon {
            width: 24px;
            height: 24px;
            color: var(--canvas-icon-color);
            transition: color var(--transition-speed-normal) ease;
        }
        .canvas-toggle-label input:checked ~ .canvas-toggle-icon {
            color: var(--canvas-icon-color-active);
        }

        .canvas-card {
            margin-top: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease;
            display: flex;
            align-items: center;
            gap: 12px;
            background-color: var(--bg-input);
        }
        .canvas-card:hover {
            background-color: var(--bg-input-focus);
        }
        .canvas-card-icon {
            flex-shrink: 0;
            color: var(--text-secondary);
        }
        .canvas-card-title {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* --- 8. Responsiveness --- */
        @media (max-width: 768px) {
            .chat-header { padding: 0 16px; }
            .header-title-group h1, #selected-model-display { font-size: 1.25rem; }
            .welcome-message h2 { font-size: 2.5rem; text-align: center; }
            .chat-input-area { padding: 8px 16px 12px 16px; }
            #chatOutput { padding: 16px; }
            .header-right { gap: 4px; }
            .message-wrapper.user .message-actions {display: flex !important;opacity: 1 !important;}
            .message-actions {
                opacity: 1;
                transform: translateY(0)!important;
            }
            .delete-chat-btn {
                opacity: 0.7;
            }
        }
        .edit-button {
            margin-left: auto; /* 使按钮靠右 */
        }
    </style>
</head>
<body>

<div class="app-container" id="app-container">
    <div id="sidebar-backdrop"></div>
    
    <aside id="sidebar">
        <div class="sidebar-header">
            <button id="new-chat-btn">
                <span class="icon-placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </span>
                <span>New chat</span>
            </button>
        </div>
        
        <div id="history-list"></div>

        <div id="sidebar-footer">
            <div id="settings-menu">
                 <div class="settings-menu-item" id="preferences-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                    <span>应用偏好</span>
                 </div>
                 <div class="settings-menu-item" id="advanced-presets-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3z"></path><polyline points="15 3 15 8 20 8"></polyline></svg>
                    <span>高级预设</span>
                 </div>
                 <div class="settings-menu-item" id="changelog-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span>更新日志</span>
                 </div>
            </div>
            <div id="settings-button" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </div>
        </div>
    </aside>

    <div class="main-content-area">
        <main class="chat-area" id="chat-area">
            <header class="chat-header">
                <div class="header-left">
                    <button id="menu-toggle-btn" class="icon-button" title="菜单">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                    <div class="header-title-group">
                        <h1>Geminisnow</h1>
                        <div class="model-selector-wrapper">
                            <div class="selected-model" id="selected-model-container">
                                <span id="selected-model-display"></span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </div>
                            <div class="model-dropdown" id="model-dropdown-list"></div>
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <button id="summarize-btn" class="action-button" title="总结对话" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3C7.03 3 3 7.03 3 12S7.03 21 12 21s9-4.03 9-9c0-1.06-.18-2.08-.5-3.02"></path><path d="M15.64 4.36A9 9 0 0 0 12 3v0"></path><path d="M12 3C7.03 3 3 7.03 3 12S7.03 21 12 21s9-4.03 9-9c0-1.06-.18-2.08-.5-3.02"></path><path d="M15.64 4.36A9 9 0 0 0 12 3v0"></path><path d="M16 8L12 12L8 8"></path><path d="M12 16V12"></path></svg>
                        <span>总结</span>
                    </button>
                    <div class="ultra-badge" id="ultra-badge">ULTRA</div>
                </div>
            </header>
            
            <div class="chat-output-wrapper">
                <div id="chatOutput">
                    <div class="chat-content-container">
                        <div class="welcome-container">
                            <div class="welcome-message">
                                <h2 id="welcome-text"></h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="chat-input-container">
                    <div class="chat-input">
                        <!-- Canvas Toggle Button -->
                        <label class="canvas-toggle-label" id="canvas-toggle-label" title="Canvas 模式">
                            <input type="checkbox" id="canvas-toggle">
                            <svg class="canvas-toggle-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
                        </label>
                        <textarea id="userInput" placeholder="问一问Gemini" autocomplete="off" rows="1"></textarea>
                        <button id="sendButton" title="发送">
                            <svg class="send-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                            <svg class="stop-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" fill="currentColor"></rect></svg>
                        </button>
                    </div>
                </div>
                 <p class="disclaimer-text">Gemini 的回答未必正确无误，请仔细核查</p>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div id="custom-modal" class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button id="modal-close-custom" class="modal-close-btn">&times;</button>
            </div>
            <p id="modal-message"></p>
            <div id="modal-input-wrapper"><input type="text" id="modal-input" autocomplete="off"></div>
            <div id="modal-button-wrapper">
                <button id="modal-cancel-btn" class="modal-btn"></button>
                <button id="modal-confirm-btn" class="modal-btn"></button>
            </div>
        </div>
    </div>
    <div id="presets-modal-overlay" class="modal-overlay">
        <div id="presets-modal" class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">预设指令</h3>
                <button class="modal-close-btn" data-target="presets-modal-overlay">&times;</button>
            </div>
            <p class="modal-intro">启用下方开关并输入你的指令。该指令将作为持续性的系统级提示词，将在后台生效，不会出现在聊天记录中。<br><b>开启后进行聊天的任何对话都会持续受到影响。</b></p>
            <div class="custom-preset-container">
                <div class="custom-preset-toggle-wrapper">
                    <label for="custom-preset-toggle">启用自定义预设指令</label>
                    <label class="switch"><input type="checkbox" id="custom-preset-toggle"><span class="slider"></span></label>
                </div>
                <textarea id="custom-preset-input" placeholder="例：你是一位专业翻译，请将我的所有输入都翻译成英文。"></textarea>
            </div>
        </div>
    </div>
    <div id="preferences-modal-overlay" class="modal-overlay">
        <div id="preferences-modal" class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">偏好设置</h3>
                <button class="modal-close-btn" data-target="preferences-modal-overlay">&times;</button>
            </div>
            <p class="modal-intro">管理应用的基本行为和偏好。</p>
            <div class="options-list">
                <div class="option-item">
                    <div>
                        <label for="dark-mode-toggle">暗黑模式</label>
                        <p class="jieshao">切换亮色或暗色主题</p>
                    </div>
                    <label class="switch"><input type="checkbox" id="dark-mode-toggle"><span class="slider"></span></label>
                </div>
                <div class="option-item">
                    <div>
                        <label for="streaming-toggle">流式传输</label>
                        <p class="jieshao">建议保持开启</p>
                    </div>
                    <label class="switch"><input type="checkbox" id="streaming-toggle"><span class="slider"></span></label>
                </div>
                <div class="option-item">
                    <div>
                        <label for="temperature-slider">Temperature: <span id="temperature-value">1.0</span></label>
                        <p class="jieshao">控制输出的随机性，越高想象力越丰富</p>
                    </div>
                    <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="1">
                </div>
                <div class="option-item">
                    <div>
                        <label for="max-output-tokens-input">最大输出长度 (tokens)</label>
                        <p class="jieshao">控制单次返回内容的最大长度</p>
                    </div>
                    <input type="number" id="max-output-tokens-input" value="65536" style="width: 100px; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary);">
                </div>
            </div>
        </div>
    </div>

    <!-- 更新日志版本列表弹窗 -->
    <div id="changelog-modal-overlay" class="modal-overlay">
        <div id="changelog-modal" class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">更新日志</h3>
                <button class="modal-close-btn" data-target="changelog-modal-overlay">&times;</button>
            </div>
            <div id="changelog-buttons-container" style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                <!-- 版本按钮将由 JS 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 单个版本更新详情弹窗 -->
    <div id="version-details-modal-overlay" class="modal-overlay">
        <div id="version-details-modal" class="modal-content">
            <div class="modal-header">
                <h3 id="version-details-title" class="modal-title"></h3> <!-- 标题将动态填充 -->
                <button class="modal-close-btn" data-target="version-details-modal-overlay">&times;</button>
            </div>
            <!-- 内容将动态填充 -->
            <div id="version-details-content" style="margin-top: 16px; line-height: 1.6; max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- Canvas Display Modal (NEW) -->
    <div id="canvas-display-modal-overlay" class="modal-overlay">
        <div id="canvas-display-modal" class="modal-content" style="max-width: 90vw; width: 1000px; height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 id="canvas-display-title" class="modal-title"></h3>
                <button class="modal-close-btn" data-target="canvas-display-modal-overlay">&times;</button>
            </div>
            <div id="canvas-display-content" contenteditable="true" style="flex-grow: 1; overflow-y: auto; padding: 16px; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 16px; line-height: 1.7; outline: none;"></div>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Element References ---
    const appContainer = document.getElementById('app-container');
    const menuToggleButton = document.getElementById('menu-toggle-btn');
    const sidebarBackdrop = document.getElementById('sidebar-backdrop');
    const settingsButton = document.getElementById('settings-button');
    const settingsMenu = document.getElementById('settings-menu');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const chatOutput = document.getElementById('chatOutput');
    const selectedModelContainer = document.getElementById('selected-model-container');
    const selectedModelDisplay = document.getElementById('selected-model-display');
    const modelDropdownList = document.getElementById('model-dropdown-list');
    const newChatButton = document.getElementById('new-chat-btn');
    const historyList = document.getElementById('history-list');
    const advancedPresetsButton = document.getElementById('advanced-presets-button');
    const presetsModalOverlay = document.getElementById('presets-modal-overlay');
    const customPresetToggle = document.getElementById('custom-preset-toggle');
    const customPresetInput = document.getElementById('custom-preset-input');
    const preferencesButton = document.getElementById('preferences-button');
    const preferencesModalOverlay = document.getElementById('preferences-modal-overlay');
    const streamingToggle = document.getElementById('streaming-toggle');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const ultraBadge = document.getElementById('ultra-badge');
    const customModalOverlay = document.getElementById('custom-modal-overlay');
    const modalCloseCustomBtn = document.getElementById('modal-close-custom');
    const temperatureSlider = document.getElementById('temperature-slider');
    const temperatureValue = document.getElementById('temperature-value');
    const summarizeBtn = document.getElementById('summarize-btn');
    const changelogButton = document.getElementById('changelog-button');
    const changelogModalOverlay = document.getElementById('changelog-modal-overlay');
    const versionDetailsModalOverlay = document.getElementById('version-details-modal-overlay');
    const changelogButtonsContainer = document.getElementById('changelog-buttons-container');
    
    // --- Canvas Elements ---
    const canvasToggle = document.getElementById('canvas-toggle');
    const canvasToggleLabel = document.getElementById('canvas-toggle-label');
    const canvasDisplayModalOverlay = document.getElementById('canvas-display-modal-overlay');
    const canvasDisplayTitle = document.getElementById('canvas-display-title');
    const canvasDisplayContent = document.getElementById('canvas-display-content');


    // --- State & Config ---
    const API_URL = '/api/askGemini';
    let abortController = null;
    let isProUnlocked = false;
    const models = [
        { id: 'gemini-2.5-flash', name: '2.5 Flash', description: '快速提供全方位的帮助', locked: false },
        { id: 'gemini-2.5-pro', name: '2.5 Pro', description: '推理、数学和编码，思考时间长', locked: false },
        { id: 'gemini-2.0-flash', name: '2.0 Flash', description: '以最快速度提供帮助', locked: false },
        { id: 'gemini-2.5-flash-lite-preview-06-17', name: '2.5 Lite', description: '最具成本效益且支持高吞吐量', locked: false },
        { id: 'gemini-2.0-flash-lite', name: '2.0 Lite', description: '成本效益和低延迟', locked: false }
    ];
    const changelogData = {
        "1.3.2": {
            title: "v1.3.2 (Canvas Logic & API Fix)",
            description: `<ul>
                            <li><strong>修复: API 错误:</strong> 修复了在已有 Canvas 的对话中继续提问时，因发送了不兼容的数据结构而导致的 API 500 错误。</li>
                            <li><strong>新功能: 永久 Canvas 模式:</strong> 一旦对话中生成了 Canvas，该对话的 Canvas 模式将被永久锁定开启，以保证后续对话的连贯性。</li>
                            <li><strong>优化: 交互提示:</strong> 当用户试图关闭一个已锁定的 Canvas 对话模式时，会收到明确的提示信息。</li>
                            <li><strong>优化: 新对话默认值:</strong> 确保所有新对话都默认关闭 Canvas 模式。</li>
                        </ul>`
        },
        "1.3.1": {
            title: "v1.3.1 (Bug Fixes & History Migration)",
            description: `<ul>
                            <li><strong>修复: 历史记录丢失:</strong> 增加自动迁移逻辑，将旧版 v6 聊天记录无缝迁移至 v7，确保用户数据不丢失。</li>
                            <li><strong>修复: Canvas 功能:</strong> 重构了 Canvas 模式下的消息处理流程，确保 AI 回复、Canvas 卡片被正确保存和渲染。</li>
                            <li><strong>修复: 功能按钮丢失:</strong> 修复了在 Canvas 模式下，编辑、复制、改写等按钮消失的问题。</li>
                        </ul>`
        },
        "1.3.0": {
            title: "v1.3.0 (Canvas Integration)",
            description: `<ul>
                            <li><strong>新功能: Canvas 集成:</strong> 将 Canvas 功能与聊天流程深度融合。</li>
                            <li><strong>优化: 多 Canvas 支持:</strong> 一次对话中可以包含多个 Canvas 文档。</li>
                        </ul>`
        },
    };
    let currentModel = 'gemini-2.5-flash-lite-preview-06-17';
    let currentChatId = null;
    let isEditing = false;
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let currentEditingCanvas = { chatId: null, messageIndex: -1 };


    marked.setOptions({ breaks: true, sanitize: true });

    // --- Core Functions ---
    
    const setRandomWelcomeMessage = () => {
        const welcomeTexts = [
            "有什么能帮忙的吗？", "知识就像面包...", "今天心情如何？", "想法，无限放大",
            "是的！船长！", "嘿，来点什么？", "让想法飞一会儿", "答案正在路上…",
            "你的超级外挂已上线", "试试问我点难的？", "随时待命！", "智慧无界，问答无阻",
        ];
        const welcomeTextElement = document.getElementById('welcome-text');
        if (welcomeTextElement) {
            const randomIndex = Math.floor(Math.random() * welcomeTexts.length);
            welcomeTextElement.textContent = welcomeTexts[randomIndex];
        }
    };

    const toggleModal = (modalOverlay, show) => {
        if (show) {
            modalOverlay.classList.add('active');
        } else {
            modalOverlay.classList.remove('active');
        }
    };

    const showCustomModal = (options) => {
        const config = { type: 'alert', title: '', message: '', placeholder: '', confirmText: '确定', cancelText: '取消', showCancel: true, isSummary: false };
        Object.assign(config, options);
        
        toggleModal(customModalOverlay, true);
        const modalContent = customModalOverlay.querySelector('.modal-content');
        document.getElementById('modal-title').textContent = config.title;
        document.getElementById('modal-message').textContent = config.message;
        const inputWrapper = document.getElementById('modal-input-wrapper');
        const inputEl = document.getElementById('modal-input');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');
        
        modalContent.classList.toggle('content-fade-in', config.isSummary);
        if (config.isSummary) {
            setTimeout(() => modalContent.classList.remove('content-fade-in'), 500);
        }
        
        if (config.confirmText) {
            confirmBtn.style.display = 'inline-block';
            confirmBtn.textContent = config.confirmText;
        } else {
            confirmBtn.style.display = 'none';
        }

        cancelBtn.textContent = config.cancelText;
        inputEl.placeholder = config.placeholder;
        inputEl.value = '';
        
        inputWrapper.style.display = config.type === 'prompt' ? 'block' : 'none';
        cancelBtn.style.display = (config.type === 'alert' || !config.showCancel) ? 'none' : 'inline-block';
        
        if (config.type === 'prompt') inputEl.focus();

        return new Promise((resolve) => {
            let isResolved = false;
            const close = (value) => {
                if (isResolved) return;
                isResolved = true;
                toggleModal(customModalOverlay, false);
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
                customModalOverlay.onclick = null;
                inputEl.onkeydown = null;
                modalCloseCustomBtn.onclick = null;
                resolve(value);
            };
            
            confirmBtn.onclick = () => close(config.type === 'prompt' ? inputEl.value : true);
            cancelBtn.onclick = () => close(config.type === 'prompt' ? null : false);
            modalCloseCustomBtn.onclick = () => cancelBtn.onclick();
            customModalOverlay.onclick = (e) => { if (e.target === customModalOverlay) cancelBtn.onclick(); };
            inputEl.onkeydown = (e) => { if (e.key === 'Enter') confirmBtn.click(); else if (e.key === 'Escape') cancelBtn.click(); }
        });
    };

    // --- Local Storage Functions ---
    const getChats = () => JSON.parse(localStorage.getItem('geminiSnowChats_v7') || '[]');
    const saveChats = (chats) => localStorage.setItem('geminiSnowChats_v7', JSON.stringify(chats));
    const getCustomPreset = () => JSON.parse(localStorage.getItem('geminiSnowCustomPreset_v6') || '{ "enabled": false, "prompt": "" }');
    const saveCustomPreset = (settings) => localStorage.setItem('geminiSnowCustomPreset_v6', JSON.stringify(settings));
    const getStreamingState = () => localStorage.getItem('geminiSnowStreaming_v6') === null ? true : JSON.parse(localStorage.getItem('geminiSnowStreaming_v6'));
    const saveStreamingState = (isEnabled) => localStorage.setItem('geminiSnowStreaming_v6', JSON.stringify(isEnabled));
    const getTemperature = () => localStorage.getItem('geminiSnowTemperature_v6') || '1';
    const saveTemperature = (value) => localStorage.setItem('geminiSnowTemperature_v6', value);
    const getThemeState = () => localStorage.getItem('geminiSnowTheme_v1') || 'light';
    const saveThemeState = (theme) => localStorage.setItem('geminiSnowTheme_v1', theme);
    const getMaxOutputTokens = () => localStorage.getItem('geminiSnowMaxTokens_v1') || '65536';
    const saveMaxOutputTokens = (value) => localStorage.setItem('geminiSnowMaxTokens_v1', value);

    const deleteChat = async (chatIdToDelete) => {
        let chats = getChats();
        const chatToDelete = chats.find(chat => chat.id === chatIdToDelete);
        if (!chatToDelete) return;

        const confirmed = await showCustomModal({
            type: 'confirm',
            title: '删除对话',
            message: `您确定要删除对话 "${chatToDelete.title}" 吗？此操作无法撤销。`,
            confirmText: '删除',
            cancelText: '取消'
        });

        if (confirmed) {
            chats = chats.filter(chat => chat.id !== chatIdToDelete);
            saveChats(chats);
            if (currentChatId === chatIdToDelete) {
                createNewChat();
            } else {
                renderHistoryList();
            }
        }
    };

    const renderHistoryList = () => {
        const chats = getChats();
        historyList.innerHTML = '';
        chats.forEach(chat => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.dataset.chatId = chat.id;

            const title = document.createElement('div');
            title.className = 'history-item-title';
            title.textContent = chat.title;
            item.addEventListener('click', () => {
                if (sendButton.classList.contains('is-loading') || isEditing) return;
                loadChat(chat.id);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-chat-btn';
            deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteChat(chat.id);
            });

            if (chat.id === currentChatId) item.classList.add('active');
            item.appendChild(title);
            item.appendChild(deleteBtn);
            historyList.prepend(item);
        });
    };
    
    const renderChatWindow = (messages) => {
        const container = document.createElement('div');
        container.className = 'chat-content-container';
        chatOutput.innerHTML = '';
        chatOutput.appendChild(container);
        messages.forEach((msg, index) => {
            if (msg.parts && msg.parts[0].text !== 'loading') {
                const messageWrapper = appendMessage(msg.role, msg.parts[0].text, container, msg.canvas);
                if (msg.role === 'model') {
                    addActionsToModelMessage(messageWrapper, index === messages.length -1);
                }
            }
        });
        updateActionButtons();
        chatOutput.scrollTop = chatOutput.scrollHeight;
    };
    
    const loadChat = (chatId) => {
        const chats = getChats();
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            currentChatId = chatId;
            renderChatWindow(chat.messages);
            renderHistoryList();
            setLoading(false);
            updateHeaderButtons();
            
            // ** NEW: Logic for persistent canvas mode **
            if (chat.isCanvasChat) {
                canvasToggle.checked = true;
                canvasToggle.disabled = true;
            } else {
                canvasToggle.checked = false;
                canvasToggle.disabled = false;
            }

            if(window.innerWidth <= 768) {
                appContainer.classList.add('sidebar-collapsed');
            }
        }
    };

    const createNewChat = () => {
        currentChatId = null;
        chatOutput.innerHTML = `
            <div class="chat-content-container">
                <div class="welcome-container">
                    <div class="welcome-message">
                        <h2 id="welcome-text"></h2>
                    </div>
                </div>
            </div>`;
        setRandomWelcomeMessage();
        renderHistoryList();
        userInput.value = '';
        userInput.style.height = 'auto';
        sendButton.classList.remove('visible');
        setLoading(false);
        updateActionButtons();
        updateHeaderButtons();
        
        // ** NEW: Reset canvas toggle for new chats **
        canvasToggle.checked = false;
        canvasToggle.disabled = false;

        setInitialSidebarState();
    };

    const handleSend = async () => {
        const prompt = userInput.value.trim();
        if (!prompt || sendButton.classList.contains('is-loading')) return;
        
        const chats = getChats();
        const chat = chats.find(c => c.id === currentChatId);

        // ** NEW: Check if chat is already a canvas chat OR if toggle is manually enabled **
        if ((chat && chat.isCanvasChat) || canvasToggle.checked) {
            await handleChatAndCanvasSend(prompt);
        } else {
            await handleChatSend(prompt);
        }
    };

    const handleChatSend = async (prompt) => {
        setLoading(true);
        userInput.value = '';
        userInput.style.height = 'auto';

        let chatContentContainer = chatOutput.querySelector('.chat-content-container');
        if (!chatContentContainer || chatContentContainer.querySelector('.welcome-container')) {
            chatContentContainer = document.createElement('div');
            chatContentContainer.className = 'chat-content-container';
            chatOutput.innerHTML = '';
            chatOutput.appendChild(chatContentContainer);
        }

        let chats = getChats();
        let isNewChat = false;
        let chat;
        if (!currentChatId) {
            isNewChat = true;
            currentChatId = `chat_${Date.now()}`;
            chat = { id: currentChatId, title: prompt.substring(0, 30), messages: [], isCanvasChat: false }; // Add isCanvasChat flag
            chats.push(chat);
        } else {
            chat = chats.find(c => c.id === currentChatId);
        }
        
        const historyForAPI = buildHistoryWithPresets([...chat.messages]);
        
        chat.messages.push({ role: 'user', parts: [{ text: prompt }] });
        saveChats(chats);
        
        appendMessage('user', prompt, chatContentContainer);
        const loadingMsgWrapper = appendMessage('model', 'loading', chatContentContainer);
        
        if (isNewChat) {
            renderHistoryList();
            updateHeaderButtons();
        }
        
        await streamResponse(prompt, loadingMsgWrapper, historyForAPI);
    };
    
    const streamResponse = async (prompt, messageWrapperElement, historyForAPI) => {
        updateActionButtons();
        abortController = new AbortController();
        const messageElement = messageWrapperElement.querySelector('.message');
        
        const isStreamingEnabled = getStreamingState();
        const temperature = getTemperature();
        const maxOutputTokens = getMaxOutputTokens();

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    prompt, 
                    history: historyForAPI, 
                    model: currentModel, 
                    stream: isStreamingEnabled,
                    temperature: parseFloat(temperature),
                    maxOutputTokens: parseInt(maxOutputTokens, 10)
                }),
                signal: abortController.signal
            });
            
            if (!response.ok) {
                 const errorText = await response.text();
                 throw new Error(`服务器错误 ${response.status}: ${errorText}`);
            }
            
            let fullText;
            if (isStreamingEnabled && response.body) {
                fullText = await streamIntoElement(response, messageElement);
            } else {
                const data = await response.json();
                fullText = data.text; 
                messageElement.classList.remove('thinking-animation');
                messageElement.innerHTML = marked.parse(fullText);
                messageElement.classList.add('fade-in-whole');
                addCopyButtonsToCodeBlocks(messageElement);
            }
            
            if(fullText === null) return;
            
            let chats = getChats();
            let chat = chats.find(c => c.id === currentChatId);
            const modelMessage = { role: 'model', parts: [{ text: fullText }] };
            
            chat.messages.push(modelMessage);

            saveChats(chats);
            
            addActionsToModelMessage(messageWrapperElement, true);
            updateActionButtons();
            updateHeaderButtons();

        } catch (error) {
            if (error.name === 'AbortError') {
                updateMessage(messageWrapperElement, '已停止生成。');
            } else {
                console.error("Fetch error:", error);
                let displayMessage = '<b>抱歉，出错了。</b><br>';
                const errorMessage = error.message || '';

                const statusMatch = errorMessage.match(/服务器错误 (\d+)/);
                const statusCode = statusMatch ? statusMatch[1] : 'N/A';
                
                displayMessage += `<b>错误码:</b> ${statusCode}<br>`;
                
                if (errorMessage.includes('All API keys failed')) {
                    displayMessage += '<b>原因:</b> 所有可用API均尝试失败。请向开发者汇报错误信息。';
                } else if (errorMessage.includes('Invalid JSON payload')) {
                    displayMessage += '<b>原因:</b> 发送给API的数据格式错误，请联系开发者修复。';
                } else {
                    const cleanMessage = errorMessage.replace(/服务器错误 \d+: /, '');
                    displayMessage += `<b>详情:</b> ${cleanMessage}`;
                }
                
                updateMessage(messageWrapperElement, displayMessage);
            }
            messageElement.classList.remove('thinking-animation');
        } finally {
            abortController = null;
            setLoading(false);
            updateActionButtons();
        }
    };
    
    const streamIntoElement = async (response, element) => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';
        
        element.classList.remove('thinking-animation');
        element.innerHTML = ''; 

        while (true) {
            try {
                const { done, value } = await reader.read();
                if (done) break;

                fullText += decoder.decode(value, { stream: true });
                element.innerHTML = marked.parse(fullText + '▋'); 
                chatOutput.scrollTop = chatOutput.scrollHeight;
            } catch (error) {
                if (error.name === 'AbortError') return null;
                throw error;
            }
        }
        element.innerHTML = marked.parse(fullText);
        addCopyButtonsToCodeBlocks(element);
        chatOutput.scrollTop = chatOutput.scrollHeight;
        return fullText;
    };
    
    const setLoading = (isLoading) => {
        userInput.disabled = isLoading;
        newChatButton.disabled = isLoading;
        // Keep canvas toggle enabled unless it's a persistent canvas chat
        const chats = getChats();
        const chat = chats.find(c => c.id === currentChatId);
        if (!chat || !chat.isCanvasChat) {
            canvasToggle.disabled = isLoading;
        }

        if (isLoading) {
            sendButton.classList.add('is-loading');
            if (!isEditing) {
                sendButton.classList.add('visible');
            }
            sendButton.title = '停止';
        } else {
            sendButton.classList.remove('is-loading');
            sendButton.title = '发送';
            if (userInput.value.trim().length === 0) {
                sendButton.classList.remove('visible');
            }
        }
    };
    
    const appendMessage = (sender, text, container, canvasData = null) => {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message-wrapper ${sender}`;
            
        const messageContentHTML = text === 'loading'
            ? `<div class="message thinking-animation">思考中...</div>`
            : `<div class="message">${marked.parse(text)}</div>`;
            
        messageWrapper.innerHTML = messageContentHTML;
        
        if (canvasData) {
            const canvasCard = document.createElement('div');
            canvasCard.className = 'canvas-card';
            canvasCard.innerHTML = `
                <svg class="canvas-card-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
                <span class="canvas-card-title">${canvasData.title}</span>
            `;
            canvasCard.addEventListener('click', () => {
                const chats = getChats();
                const chat = chats.find(c => c.id === currentChatId);
                if (!chat) return;
                const messageIndex = chat.messages.findIndex(m => m.canvas && m.canvas.id === canvasData.id);
                if (messageIndex > -1) {
                    displayCanvas(currentChatId, messageIndex, chat.messages[messageIndex].canvas);
                }
            });
            messageWrapper.appendChild(canvasCard);
        }
        
        container.appendChild(messageWrapper);
        chatOutput.scrollTop = chatOutput.scrollHeight;
        
        if (sender === 'model' && text !== 'loading') {
             addCopyButtonsToCodeBlocks(messageWrapper);
        }
        
        return messageWrapper;
    };

    const updateMessage = (messageWrapperElement, newContent, canvasData = null) => {
        const messageElement = messageWrapperElement.querySelector('.message');
        if (messageElement) {
            messageElement.innerHTML = newContent.includes("<b>") ? newContent : marked.parse(newContent);
            if(!newContent.includes("<b>")) {
               addCopyButtonsToCodeBlocks(messageElement);
            }
        }
        if (canvasData) {
             const canvasCard = document.createElement('div');
            canvasCard.className = 'canvas-card';
            canvasCard.innerHTML = `
                <svg class="canvas-card-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
                <span class="canvas-card-title">${canvasData.title}</span>
            `;
            canvasCard.addEventListener('click', () => {
                const chats = getChats();
                const chat = chats.find(c => c.id === currentChatId);
                if (!chat) return;
                const messageIndex = chat.messages.findIndex(m => m.canvas && m.canvas.id === canvasData.id);
                if (messageIndex > -1) {
                    displayCanvas(currentChatId, messageIndex, chat.messages[messageIndex].canvas);
                }
            });
            messageWrapperElement.appendChild(canvasCard);
        }
    };

    const addCopyButtonsToCodeBlocks = (container) => {
        const codeBlocks = container.querySelectorAll('pre');
        codeBlocks.forEach(block => {
            if (block.querySelector('.copy-code-button')) return;
            const button = document.createElement('button');
            button.className = 'copy-code-button';
            button.textContent = 'Copy';
            button.onclick = () => {
                const code = block.querySelector('code').innerText;
                navigator.clipboard.writeText(code).then(() => {
                    button.textContent = 'Copied!';
                    setTimeout(() => { button.textContent = 'Copy'; }, 2000);
                });
            };
            block.appendChild(button);
        });
    };
    
    // ** FIXED: Filter out 'canvas' property before sending to API **
    const buildHistoryWithPresets = (history) => {
        const cleanHistory = history.map(msg => ({
            role: msg.role,
            parts: msg.parts
        }));

        const customPreset = getCustomPreset();
        if (customPreset.enabled && customPreset.prompt && customPreset.prompt.trim() !== '') {
            const presetMessages = [
                { role: 'user', parts: [{ text: `System instruction: ${customPreset.prompt.trim()}` }] },
                { role: 'model', parts: [{ text: 'OK, I will follow that instruction.' }] }
            ];
            return [...presetMessages, ...cleanHistory];
        }
        return cleanHistory;
    };

    const updateHeaderButtons = () => {
        const chats = getChats();
        const chat = chats.find(c => c.id === currentChatId);
        if (chat && chat.messages.length >= 2) {
            summarizeBtn.style.display = 'flex';
        } else {
            summarizeBtn.style.display = 'none';
        }
    };

    const updateActionButtons = () => {
        document.querySelectorAll('.message-actions').forEach(el => el.remove());

        const chats = getChats();
        const chat = chats.find(c => c.id === currentChatId);
        if (!chat || chat.messages.length === 0 || isEditing || sendButton.classList.contains('is-loading')) {
            return;
        }

        const userMessages = document.querySelectorAll('.message-wrapper.user');
        if (userMessages.length > 0) {
            const lastUserMessageWrapper = userMessages[userMessages.length - 1];
            const lastUserMessageIndex = chat.messages.map(m => m.role).lastIndexOf('user');
            
            if (lastUserMessageIndex === chat.messages.length - 1) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'action-button edit-button';
                editBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path>
                        <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
                    </svg>
                    <span>编辑</span>
                `;
                
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleEdit(lastUserMessageWrapper);
                });
                
                actionsDiv.appendChild(editBtn);
                lastUserMessageWrapper.appendChild(actionsDiv);
            }
        }

        const modelMessages = document.querySelectorAll('.message-wrapper.model');
        if (modelMessages.length > 0) {
            modelMessages.forEach((msgWrapper, index) => {
                 addActionsToModelMessage(msgWrapper, index === modelMessages.length - 1);
            });
        }
    };
    
    const addActionsToModelMessage = (messageWrapper, isLastMessage) => {
        if (messageWrapper.querySelector('.message-actions')) return;

        const actionWrapper = document.createElement('div');
        actionWrapper.className = 'message-actions';
        
        const copyButton = document.createElement('button');
        copyButton.className = 'action-button copy-message-button';
        copyButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            <span>复制</span>
        `;
        copyButton.onclick = () => {
            const messageText = messageWrapper.querySelector('.message').innerText;
            navigator.clipboard.writeText(messageText).then(() => {
                const span = copyButton.querySelector('span');
                span.textContent = '已复制!';
                setTimeout(() => { span.textContent = '复制'; }, 2000);
            });
        };
        actionWrapper.appendChild(copyButton);

        if (isLastMessage) {
            const regenerateButton = document.createElement('button');
            regenerateButton.className = 'action-button regenerate-button';
            regenerateButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
                <span>重新生成</span>
            `;
            regenerateButton.onclick = handleRegenerate;
            actionWrapper.appendChild(regenerateButton);

            const rewriteButton = document.createElement('button');
            rewriteButton.className = 'action-button rewrite-button';
            rewriteButton.innerHTML = `✨ <span>改写</span>`;

            const rewriteOptions = document.createElement('div');
            rewriteOptions.className = 'rewrite-options';
            rewriteOptions.innerHTML = `
                <button class="action-button" data-rewrite-action="longer">扩写</button>
                <button class="action-button" data-rewrite-action="simpler">简化</button>
            `;

            rewriteButton.onclick = (e) => {
                e.stopPropagation();
                document.querySelectorAll('.rewrite-options.visible').forEach(opt => {
                    if (opt !== rewriteOptions) opt.classList.remove('visible');
                });
                rewriteOptions.classList.toggle('visible');
            };
            
            rewriteOptions.addEventListener('click', (e) => {
                if (e.target.matches('[data-rewrite-action]')) {
                    const action = e.target.dataset.rewriteAction;
                    handleRewrite(messageWrapper, action);
                    rewriteOptions.classList.remove('visible');
                }
            });

            actionWrapper.appendChild(rewriteButton);
            actionWrapper.appendChild(rewriteOptions);
        }
        
        messageWrapper.insertBefore(actionWrapper, messageWrapper.firstChild);
        setTimeout(() => {
            actionWrapper.style.opacity = 1;
            actionWrapper.style.transform = 'translateY(0)';
        }, 10);
    };

    const handleEdit = (messageWrapper) => {
        if (isEditing) return;
        isEditing = true;
        sendButton.classList.add('hidden-by-edit');
        updateActionButtons();
        
        const messageDiv = messageWrapper.querySelector('.message');
        const originalHTML = messageDiv.innerHTML;
        const chats = getChats();
        const chat = chats.find(c => c.id === currentChatId);
        const messageIndex = Array.from(messageWrapper.parentElement.children).indexOf(messageWrapper);
        const originalText = chat.messages[messageIndex].parts[0].text;

        messageDiv.innerHTML = '';
        const editTextArea = document.createElement('textarea');
        editTextArea.style.cssText = `width: 100%; height: auto; background: transparent; border: none; color: var(--text-primary); resize: none; outline: none; font-size: inherit; line-height: inherit; padding: 1rem 1.25rem;`;
        editTextArea.value = originalText;
        messageDiv.appendChild(editTextArea);
        
        messageDiv.classList.add('is-editing');
        
        const setHeight = () => {
            editTextArea.style.height = 'auto';
            editTextArea.style.height = `${editTextArea.scrollHeight}px`;
        };
        setTimeout(setHeight, 0);
        editTextArea.addEventListener('input', setHeight);
        editTextArea.focus();
        editTextArea.setSelectionRange(originalText.length, originalText.length);

        const actionWrapper = document.createElement('div');
        actionWrapper.className = 'message-actions';
        actionWrapper.style.opacity = 1;
        actionWrapper.style.transform = 'translateY(0)';
        actionWrapper.innerHTML = `
            <button class="action-button save-edit-button">保存并提交</button>
            <button class="action-button cancel-edit-button">取消</button>
        `;
        messageWrapper.appendChild(actionWrapper);
        
        const cleanupEdit = () => {
            messageDiv.innerHTML = originalHTML;
            messageDiv.classList.remove('is-editing');
            actionWrapper.remove();
            isEditing = false;
            sendButton.classList.remove('hidden-by-edit');
            setLoading(false);
            updateActionButtons();
        };

        actionWrapper.querySelector('.save-edit-button').addEventListener('click', async () => {
            const newText = editTextArea.value.trim();
            isEditing = false;
            sendButton.classList.remove('hidden-by-edit');
            if (newText && newText !== originalText) {
                setLoading(true);
                let currentChats = getChats();
                let currentChat = currentChats.find(c => c.id === currentChatId);
                
                currentChat.messages.splice(messageIndex, Infinity, { role: 'user', parts: [{ text: newText }] });
                saveChats(currentChats);

                while(messageWrapper.nextSibling) {
                    messageWrapper.nextSibling.remove();
                }
                messageDiv.innerHTML = marked.parse(newText);
                messageDiv.classList.remove('is-editing');
                actionWrapper.remove();
                
                const container = document.querySelector('.chat-content-container');
                const loadingMsgWrapper = appendMessage('model', 'loading', container);
                await streamResponse(newText, loadingMsgWrapper, currentChat.messages.slice(0, -1));

            } else {
                cleanupEdit();
            }
        });

        actionWrapper.querySelector('.cancel-edit-button').addEventListener('click', cleanupEdit);
    };
    
    const handleRegenerate = async () => {
        let chats = getChats();
        let chat = chats.find(c => c.id === currentChatId);
        if (!chat || chat.messages.length < 2) return;
        
        setLoading(true);
        updateActionButtons();

        const lastModelMessage = chat.messages.pop(); 
        saveChats(chats);
        
        const lastModelMessageElement = document.querySelector('.message-wrapper.model:last-of-type');
        if (lastModelMessageElement) lastModelMessageElement.remove();
        
        const historyForAPI = buildHistoryWithPresets([...chat.messages]);
        const lastUserPrompt = chat.messages.at(-1).parts[0].text;
        
        if ((chat && chat.isCanvasChat) || (lastModelMessage && lastModelMessage.canvas)) {
            await handleChatAndCanvasSend(lastUserPrompt, true);
        } else {
            const container = document.querySelector('.chat-content-container');
            const loadingMsgWrapper = appendMessage('model', 'loading', container);
            await streamResponse(lastUserPrompt, loadingMsgWrapper, historyForAPI);
        }
    };

    // --- Gemini API Helper Functions ---
    const getGeminiResponse = async (prompt, history = []) => {
        const maxOutputTokens = getMaxOutputTokens(); 
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt,
                    history,
                    model: 'gemini-2.5-flash', 
                    stream: false,
                    temperature: 0.7,
                    maxOutputTokens: parseInt(maxOutputTokens, 10) 
                }),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            return data.text;

        } catch (error) {
            console.error("Gemini API call failed:", error);
            return `Error: ${error.message}`;
        }
    };

    const handleSummarize = async () => {
        const chats = getChats();
        const chat = chats.find(c => c.id === currentChatId);
        if (!chat || chat.messages.length < 2) {
            showCustomModal({type: 'alert', title: '无法总结', message: '对话内容过少，无法进行总结。'});
            return;
        }

        showCustomModal({
            type: 'alert',
            title: '正在生成摘要...',
            message: '请稍候，GeminiSnow 正在为您总结对话内容。',
            showCancel: false,
            confirmText: ''
        });

        const conversationText = chat.messages
            .filter(msg => msg.parts[0].text !== 'loading')
            .map(msg => `${msg.role === 'model' ? 'AI' : 'User'}: ${msg.parts[0].text}`).join('\n---\n');
        const prompt = `请根据以下对话内容，生成一个简洁的摘要，不超过三句话。摘要应客观地概括对话的核心要点。\n\n对话内容:\n${conversationText}`;

        const summary = await getGeminiResponse(prompt);

        if (!summary.startsWith('Error:')) {
            showCustomModal({
                type: 'alert',
                title: '对话摘要',
                message: summary,
                confirmText: '好的',
                isSummary: true
            });
        } else {
            showCustomModal({
                type: 'alert',
                title: '生成失败',
                message: summary,
                confirmText: '关闭'
            });
        }
    };

    const handleRewrite = async (messageWrapper, action) => {
        const messageElement = messageWrapper.querySelector('.message');
        const chats = getChats();
        const chat = chats.find(c => c.id === currentChatId);
        if (!chat) return;

        const messageIndex = Array.from(messageWrapper.parentElement.children).filter(el => el.classList.contains('message-wrapper')).indexOf(messageWrapper);
        const originalMessageText = chat.messages[messageIndex].parts[0].text;

        let prompt = '';
        switch(action) {
           case 'longer': prompt = `请将以下文本进行扩写，增加更多细节和描述,你只需要照做，不需要回复这段话:\n\n"${originalMessageText}"`; break;
            case 'simpler': prompt = `请用更简单、更通俗易懂的语言解释以下文本，字数一定要比原文更少，你只需要照做，不需要回复这段话:\n\n"${originalMessageText}"`; break;
        }
        if (!prompt) return;

        const overlay = document.createElement('div');
        overlay.className = 'message-loading-overlay';
        overlay.textContent = '改写中...';
        messageElement.appendChild(overlay);

        const rewrittenText = await getGeminiResponse(prompt);
        
        overlay.remove();
        if (!rewrittenText.startsWith('Error:')) {
            messageElement.innerHTML = marked.parse(rewrittenText);
            messageElement.classList.add('content-refreshed');
            setTimeout(() => messageElement.classList.remove('content-refreshed'), 500);
            addCopyButtonsToCodeBlocks(messageElement);
            chat.messages[messageIndex].parts[0].text = rewrittenText;
            saveChats(chats);
        } else {
            showCustomModal({type: 'alert', title: '改写失败，可能是达到后端最长反应时间限制！', message: rewrittenText});
        }
    };

    // --- Canvas Functions ---
    const handleChatAndCanvasSend = async (prompt, isRegeneration = false) => {
        setLoading(true);
        if (!isRegeneration) {
            userInput.value = '';
            userInput.style.height = 'auto';
            sendButton.classList.remove('visible');
        }

        let chatContentContainer = chatOutput.querySelector('.chat-content-container');
        if (!chatContentContainer || chatContentContainer.querySelector('.welcome-container')) {
            chatContentContainer = document.createElement('div');
            chatContentContainer.className = 'chat-content-container';
            chatOutput.innerHTML = '';
            chatOutput.appendChild(chatContentContainer);
        }

        let chats = getChats();
        let isNewChat = false;
        let chat;
        if (!currentChatId) {
            isNewChat = true;
            currentChatId = `chat_${Date.now()}`;
            chat = { id: currentChatId, title: prompt.substring(0, 30), messages: [], isCanvasChat: true }; // Set canvas mode on creation
            chats.push(chat);
            canvasToggle.checked = true;
            canvasToggle.disabled = true;
        } else {
            chat = chats.find(c => c.id === currentChatId);
            if (!chat.isCanvasChat) {
                chat.isCanvasChat = true; // Persist canvas mode
                canvasToggle.checked = true;
                canvasToggle.disabled = true;
            }
        }
        
        if (!isRegeneration) {
            chat.messages.push({ role: 'user', parts: [{ text: prompt }] });
            saveChats(chats);
            appendMessage('user', prompt, chatContentContainer);
        }
        
        const historyForAPI = buildHistoryWithPresets([...chat.messages]);
        const loadingMsgWrapper = appendMessage('model', 'loading', chatContentContainer);
        
        if (isNewChat) {
            renderHistoryList();
            updateHeaderButtons();
        }

        abortController = new AbortController();
        
        try {
            const [chatResponseText, canvasContentMarkdown] = await Promise.all([
                getGeminiResponse(prompt, historyForAPI),
                getGeminiResponse(`请就以下主题生成一份详细的、结构化的文档。请使用 Markdown 格式。主题：“${prompt}”`, [])
            ]);

            if (chatResponseText.startsWith('Error:')) throw new Error(chatResponseText);
            if (canvasContentMarkdown.startsWith('Error:')) throw new Error(canvasContentMarkdown);

            const canvasData = {
                id: `canvas_${Date.now()}`,
                title: `Canvas: ${prompt.substring(0, 40)}...`,
                content: canvasContentMarkdown
            };
            const modelMessage = { 
                role: 'model', 
                parts: [{ text: chatResponseText }],
                canvas: canvasData
            };

            chats = getChats();
            chat = chats.find(c => c.id === currentChatId);
            chat.messages.push(modelMessage);
            saveChats(chats);
            
            loadingMsgWrapper.querySelector('.message').classList.remove('thinking-animation');
            updateMessage(loadingMsgWrapper, chatResponseText, canvasData);
            addActionsToModelMessage(loadingMsgWrapper, true);

        } catch (error) {
            const messageElement = loadingMsgWrapper.querySelector('.message');
            if (error.name !== 'AbortError') {
                console.error("Canvas send error:", error);
                updateMessage(loadingMsgWrapper, `<b>抱歉，生成内容时出错了。</b><br>${error.message}`);
            } else {
                 updateMessage(loadingMsgWrapper, '已停止生成。');
            }
            if(messageElement) messageElement.classList.remove('thinking-animation');
        } finally {
            abortController = null;
            setLoading(false);
            updateActionButtons();
            updateHeaderButtons();
        }
    };

    const displayCanvas = (chatId, messageIndex, canvasObject) => {
        currentEditingCanvas = { chatId, messageIndex };
        canvasDisplayTitle.textContent = canvasObject.title;
        canvasDisplayContent.innerHTML = marked.parse(canvasObject.content);
        addCopyButtonsToCodeBlocks(canvasDisplayContent);
        toggleModal(canvasDisplayModalOverlay, true);
    };


    // --- Setup and Init Functions ---
    const migrateData = () => {
        const oldDataKey = 'geminiSnowChats_v6';
        const newDataKey = 'geminiSnowChats_v7';
        const oldData = localStorage.getItem(oldDataKey);
        const newDataExists = localStorage.getItem(newDataKey);

        if (oldData && !newDataExists) {
            console.log('Migrating chat history from v6 to v7...');
            try {
                const chats_v6 = JSON.parse(oldData);
                localStorage.setItem(newDataKey, JSON.stringify(chats_v6));
                console.log('Migration successful!');
            } catch (e) {
                console.error('Failed to migrate chat history:', e);
            }
        }
    };

    const setupModelSelector = () => {
        modelDropdownList.innerHTML = '';
        models.forEach(model => {
            const option = document.createElement('div');
            option.className = 'settings-menu-item model-option';
            option.dataset.value = model.id;
            const isLocked = model.locked && !isProUnlocked;
            if (isLocked) option.classList.add('disabled');
            
            option.innerHTML = `
                <div class="model-option-text" style="flex-grow: 1;">
                    <h4>${model.name} ${isLocked ? '🔒' : ''}</h4>
                    <p>${model.description}</p>
                </div>
                <span class="checkmark" style="visibility:hidden;">✓</span>`;
                
            if (!isLocked) {
                option.addEventListener('click', () => {
                    currentModel = model.id;
                    updateSelectorDisplay();
                    modelDropdownList.classList.remove('active');
                });
            } else {
                 option.addEventListener('click', () => showCustomModal({
                    type: 'alert', title: '模型已锁定', message: '升级到 Ultra 即可使用此模型。'
                }));
            }
            modelDropdownList.appendChild(option);
        });
        updateSelectorDisplay();
    };

    const updateSelectorDisplay = () => {
        const selectedModel = models.find(m => m.id === currentModel);
        if (selectedModel) {
            selectedModelDisplay.textContent = selectedModel.name;
        }
        ultraBadge.style.display = isProUnlocked ? 'block' : 'none';
        
        document.querySelectorAll('.model-option').forEach(opt => {
            const checkmark = opt.querySelector('.checkmark');
            if(opt.dataset.value === currentModel){
                opt.style.backgroundColor = 'var(--bg-hover-light)';
                if(checkmark) checkmark.style.visibility = 'visible';
            } else {
                opt.style.backgroundColor = 'transparent';
                if(checkmark) checkmark.style.visibility = 'hidden';
            }
        });
    };
    
    const setupPresetsModal = () => {
        const currentPreset = getCustomPreset();
        customPresetToggle.checked = currentPreset.enabled;
        customPresetInput.value = currentPreset.prompt;
        customPresetToggle.addEventListener('change', () => saveCustomPreset({ enabled: customPresetToggle.checked, prompt: customPresetInput.value }));
        customPresetInput.addEventListener('input', () => saveCustomPreset({ enabled: customPresetToggle.checked, prompt: customPresetInput.value }));
    };

    const applyTheme = (theme) => {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            document.body.classList.remove('light-mode');
        } else {
            document.body.classList.remove('dark-mode');
            document.body.classList.add('light-mode');
        }
        darkModeToggle.checked = (theme === 'dark');
    };

    const setupPreferencesModal = () => {
        const savedTheme = getThemeState();
        applyTheme(savedTheme);
        darkModeToggle.addEventListener('change', () => {
            const newTheme = darkModeToggle.checked ? 'dark' : 'light';
            applyTheme(newTheme);
            saveThemeState(newTheme);
        });

        streamingToggle.checked = getStreamingState();
        streamingToggle.addEventListener('change', () => saveStreamingState(streamingToggle.checked));

        const currentTemp = getTemperature();
        temperatureSlider.value = currentTemp;
        temperatureValue.textContent = parseFloat(currentTemp).toFixed(1);
        temperatureSlider.addEventListener('input', (e) => {
            const newTemp = e.target.value;
            temperatureValue.textContent = parseFloat(newTemp).toFixed(1);
        });
        temperatureSlider.addEventListener('change', (e) => {
            saveTemperature(e.target.value);
        });

        const maxTokensInput = document.getElementById('max-output-tokens-input');
        const MIN_TOKENS = 1024;
        const MAX_TOKENS = 65536;

        maxTokensInput.value = getMaxOutputTokens();

        maxTokensInput.addEventListener('change', (e) => {
            const value = parseInt(e.target.value, 10);

            if (!isNaN(value) && value >= MIN_TOKENS && value <= MAX_TOKENS) {
                saveMaxOutputTokens(value);
                e.target.style.borderColor = ''; 
            } else {
                e.target.style.borderColor = 'red';

                setTimeout(() => {
                    e.target.value = getMaxOutputTokens(); 
                    e.target.style.borderColor = ''; 
                }, 1500); 
            }
        });
    };

    const setupChangelog = () => {
        changelogButtonsContainer.innerHTML = '';
        Object.keys(changelogData).forEach(version => {
            const data = changelogData[version];
            const button = document.createElement('button');
            button.className = 'modal-btn';
            button.dataset.version = version;
            button.textContent = data.title;
            button.style.backgroundColor = 'var(--bg-input)';
            button.style.color = 'var(--text-primary)';
            button.style.width = '100%';
            button.style.textAlign = 'left';
            changelogButtonsContainer.appendChild(button);
        });
    };

    const setInitialSidebarState = () => {
        appContainer.classList.add('sidebar-collapsed');
    };


    // --- Event Listeners ---
    menuToggleButton.addEventListener('click', () => {
        appContainer.classList.toggle('sidebar-collapsed');
    });
    sidebarBackdrop.addEventListener('click', () => {
        appContainer.classList.add('sidebar-collapsed');
    });

    newChatButton.addEventListener('click', createNewChat);
    summarizeBtn.addEventListener('click', handleSummarize);
    
    changelogButton.addEventListener('click', () => {
        toggleModal(changelogModalOverlay, true);
        settingsMenu.classList.remove('active');
    });

    changelogButtonsContainer.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button && button.dataset.version) {
            const version = button.dataset.version;
            const data = changelogData[version];
            if (data) {
                document.getElementById('version-details-title').textContent = data.title;
                document.getElementById('version-details-content').innerHTML = data.description;
                toggleModal(changelogModalOverlay, false);
                toggleModal(versionDetailsModalOverlay, true);
            }
        }
    });

    sendButton.addEventListener('click', () => {
        if (sendButton.classList.contains('is-loading')) {
            if (abortController) abortController.abort();
        } else if(!userInput.disabled) {
            handleSend();
        }
    });

    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && !isMobile) {
            if (!userInput.disabled) {
                e.preventDefault();
                handleSend();
            }
        }
    });
    userInput.addEventListener('input', () => {
        userInput.style.height = 'auto';
        let newHeight = userInput.scrollHeight;
        const maxHeight = 125;
        if (newHeight > maxHeight) {
            newHeight = maxHeight;
            userInput.style.overflowY = 'auto';
        } else {
            userInput.style.overflowY = 'hidden';
        }
        userInput.style.height = `${newHeight}px`;

        if (!sendButton.classList.contains('is-loading')) {
            sendButton.classList.toggle('visible', userInput.value.trim().length > 0);
        }
    });
    
    selectedModelContainer.addEventListener('click', (e) => {
        e.stopPropagation();
        modelDropdownList.classList.toggle('active');
    });

    settingsButton.addEventListener('click', (e) => {
        e.stopPropagation();
        settingsMenu.classList.toggle('active');
    });

    advancedPresetsButton.addEventListener('click', () => {
        toggleModal(presetsModalOverlay, true);
        settingsMenu.classList.remove('active');
    });
    
    preferencesButton.addEventListener('click', () => {
        toggleModal(preferencesModalOverlay, true);
        settingsMenu.classList.remove('active');
    });
    
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const targetId = e.currentTarget.dataset.target;
            const modalToClose = targetId ? document.getElementById(targetId) : e.currentTarget.closest('.modal-overlay');
            if(modalToClose) toggleModal(modalToClose, false);
        });
    });
    
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                toggleModal(overlay, false);
            }
        });
    });

    document.addEventListener('click', (e) => {
        if (!modelDropdownList.contains(e.target) && !selectedModelContainer.contains(e.target)) {
            modelDropdownList.classList.remove('active');
        }
        if (!settingsMenu.contains(e.target) && !settingsButton.contains(e.target)) {
            settingsMenu.classList.remove('active');
        }
        const activeRewriteOptions = document.querySelector('.rewrite-options.visible');
        if (activeRewriteOptions && !activeRewriteOptions.parentElement.contains(e.target)) {
            activeRewriteOptions.classList.remove('visible');
        }
    });

    canvasDisplayContent.addEventListener('input', () => {
        if (currentEditingCanvas.chatId && currentEditingCanvas.messageIndex > -1) {
            const chats = getChats();
            const chat = chats.find(c => c.id === currentEditingCanvas.chatId);
            if (chat && chat.messages[currentEditingCanvas.messageIndex]) {
                chat.messages[currentEditingCanvas.messageIndex].canvas.content = canvasDisplayContent.innerText;
                saveChats(chats);
            }
        }
    });

    // ** NEW: Listener for disabled canvas toggle **
    canvasToggleLabel.addEventListener('click', (e) => {
        if (canvasToggle.disabled) {
            e.preventDefault();
            showCustomModal({
                type: 'alert',
                title: '模式已锁定',
                message: '该对话已是 Canvas 模式，无法关闭。',
                confirmText: '好的'
            });
        }
    });


    // --- App Initialization ---
    migrateData();
    setupModelSelector();
    setupPresetsModal();
    setupPreferencesModal();
    setupChangelog();
    createNewChat();

});
</script>
</body>
</html>

